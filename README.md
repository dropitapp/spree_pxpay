# SpreePxpay

Add support for Windcave (ex. PaymentExpress) PxPay 2.0 gateway.

Wraps offsite_payments gem.

Big thanks to spree-mollie-gateway.

Don't use this extension in any live system. Highly experimental. Cover it with tests first.

## Installation

1. Add this extension to your Gemfile with this line:
  ```ruby
  gem 'spree_pxpay', github: 'dropitapp/spree_pxpay'
  ```

2. Install the gem using Bundler:
  ```ruby
  bundle install
  ```

3. Copy & run migrations
  ```ruby
  bundle exec rails g spree_pxpay:install
  ```

4. Restart your server

  If your server was running, restart it so that it can find the assets properly.


## Usage

  For the overall workflow please consult the
    [Integration guide](https://www.paymentexpress.com/Document/PXECOM_PXPay_2_0_IntegrationGuide.pdf).

  Currently this extension only adds an endpoint to Spree::API::V1 which in turn queries the PxPay to grab the form URL.
  
  E.g. `curl -X POST -H "Content-Type: application/json" -H "X-Spree-Token: [API-Token]" http://localhost:3000/api/v1/pxpay.json -d '{"amount":10, "currency": "NZD", "return_url": "https://example.com", "merchant_ref": "sample"}'`
  
  For manual queries grab `[API-Token]` from the user edit screen within the Spree admin interface.
  
#### Global Options

These are provided by your Windcave account manager:

  - SpreePxpay.config[:pxpay_user_id] 
  - SpreePxpay.config[:pxpay_key]
  
Could be set via initializers in your project.
  
[your_project]/config/initializers/spree_pxpay.rb
```ruby
SpreePxpay.config do |c|
  c[:pxpay_user_id] = ENV['PXPAY_USER_ID']
  c[:pxpay_key] = ENV['PXPAY_KEY']
end
``` 

#### Transaction Request Options

These are set per request. Currently all transaction fields are parameters from the POST request.
 
Later the API endpoint will accept existing orders as inputs.

[query param] => [PxPay GenerateRequest XML field]
- merchant_ref => MerchantReference
- return_url => UrlSuccess and UrlFail. Should be fully formed, i.e. start with 'https://...'
- callback_url => UrlCallback
- amount => AmountInput
- currency => CurrencyInput
  

## Testing

TODO: This extension is not tested in any shape or form.

First bundle your dependencies, then run `rake`. `rake` will default to building the dummy app if it does not exist, then it will run specs. The dummy app can be regenerated by using `rake test_app`.

```shell
bundle
bundle exec rake
```

When testing your applications integration with this extension you may use it's factories.
Simply add this require statement to your spec_helper:

```ruby
require 'spree_pxpay/factories'
```


## Contributing

If you'd like to contribute, please take a look at the
[instructions](CONTRIBUTING.md), which don't exist :), for installing dependencies and crafting a good
pull request.

Copyright (c) 2020 DropIT Ltd, released under the New BSD License
